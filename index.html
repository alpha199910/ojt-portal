<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WVSU PC | OJT Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .wvsu-blue { background-color: #003366; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 flex flex-col items-center font-sans">

    <div id="login-screen" class="w-full max-w-sm bg-white rounded-[2rem] shadow-2xl overflow-hidden my-auto">
        <div class="wvsu-blue p-10 text-center">
            <h1 class="text-white text-3xl font-black tracking-tighter">WVSU PC</h1>
            <p class="text-blue-200 text-[10px] font-bold uppercase tracking-[0.2em] mt-1">OJT Student Portal</p>
        </div>
        <div class="p-8 space-y-4">
            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">WVSU ID Number</label>
                <input type="text" id="login-id" placeholder="Enter your ID (e.g. 2024P0000)" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl mt-1 outline-none focus:ring-2 focus:ring-blue-500 text-sm">
            </div>
            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Full Name</label>
                <input type="text" id="login-name" placeholder="Enter your Full Name" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl mt-1 outline-none focus:ring-2 focus:ring-blue-500 text-sm">
            </div>
            <button onclick="handleLogin()" class="w-full wvsu-blue text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all mt-2">LOGIN</button>
        </div>
    </div>

    <div id="dashboard-screen" class="hidden w-full max-w-sm bg-white rounded-[2.5rem] shadow-2xl overflow-hidden">
        <div class="wvsu-blue p-8 text-white">
            <h2 class="text-2xl font-black tracking-tighter italic">GeoLog</h2>
            <div class="mt-6">
                <p id="user-display-name" class="text-xl font-bold leading-tight">Student Name</p>
                <p id="user-display-id" class="text-xs text-blue-300 font-mono mt-1">ID: ---</p>
            </div>
        </div>

        <div class="p-8">
            <div id="status-box" class="bg-slate-50 p-4 rounded-2xl text-[10px] font-bold mb-6 text-center border-2 border-dashed border-slate-200 text-slate-400">
                üõ∞Ô∏è Waiting for GPS Verification
            </div>

            <div class="flex gap-2 mb-8">
                <button onclick="attendance('IN')" id="btn-in" class="flex-1 wvsu-blue text-white font-bold py-5 rounded-2xl shadow-lg active:scale-95 transition-all">CLOCK IN</button>
                <button onclick="attendance('OUT')" id="btn-out" class="hidden flex-1 bg-rose-600 text-white font-bold py-5 rounded-2xl shadow-lg active:scale-95 transition-all">CLOCK OUT</button>
            </div>

            <div class="border-t border-slate-100 pt-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Your Attendance History</h3>
                    <div class="flex gap-2">
                        <button onclick="downloadDTR()" class="text-[8px] text-blue-600 font-bold uppercase">Export</button>
                        <button onclick="clearLogs()" class="text-[8px] text-slate-300 font-bold uppercase">Clear</button>
                    </div>
                </div>
                <div id="history-list" class="space-y-3"></div>
            </div>

            <button onclick="location.reload()" class="w-full mt-10 text-slate-300 text-[10px] font-bold uppercase tracking-[0.3em] text-center">Logout</button>
        </div>
    </div>

    <script>
        // TARGET COORDINATES: POTOTAN OFFICE
        const TARGET = { lat: 10.945231, lng: 122.641032, radius: 200 };

        function handleLogin() {
            const id = document.getElementById('login-id').value.trim();
            const name = document.getElementById('login-name').value.trim();
            
            if (id && name) {
                // Store student details for the session
                sessionStorage.setItem('current_student_name', name);
                sessionStorage.setItem('current_student_id', id);

                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard-screen').classList.remove('hidden');
                document.getElementById('user-display-name').innerText = name;
                document.getElementById('user-display-id').innerText = "WVSU ID: " + id;
                renderLogs();
            } else {
                alert("Please enter both your ID and Name to log in.");
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function attendance(type) {
            const status = document.getElementById('status-box');
            status.innerHTML = "üåÄ Verifying Location...";
            
            navigator.geolocation.getCurrentPosition((pos) => {
                const dist = calculateDistance(pos.coords.latitude, pos.coords.longitude, TARGET.lat, TARGET.lng);
                const isVerified = dist <= TARGET.radius;

                if (type === 'IN' && !isVerified) {
                    status.innerHTML = `‚ùå OUT OF RANGE (${Math.round(dist)}m away)`;
                    status.className = "bg-red-50 text-red-600 p-4 rounded-2xl text-[10px] font-bold mb-6 border-2 border-red-200 text-center";
                    return;
                }

                const now = new Date();
                const studentId = sessionStorage.getItem('current_student_id');
                const logEntry = {
                    studentId: studentId,
                    type: type,
                    date: now.toLocaleDateString(),
                    time: now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                };

                // Save logs specific to this student's ID
                let logs = JSON.parse(localStorage.getItem('wvsu_logs_' + studentId)) || [];
                logs.unshift(logEntry);
                localStorage.setItem('wvsu_logs_' + studentId, JSON.stringify(logs));

                if (type === 'IN') {
                    document.getElementById('btn-in').classList.add('hidden');
                    document.getElementById('btn-out').classList.remove('hidden');
                    status.innerHTML = "‚úÖ CLOCKED IN AT " + logEntry.time;
                    status.className = "bg-green-50 text-green-700 p-4 rounded-2xl text-[10px] font-bold mb-6 border-2 border-green-200 text-center";
                    renderLogs();
                } else {
                    location.reload(); 
                }
            }, (err) => alert("Please enable GPS/Location settings."), { enableHighAccuracy: true });
        }

        function renderLogs() {
            const studentId = sessionStorage.getItem('current_student_id');
            const logs = JSON.parse(localStorage.getItem('wvsu_logs_' + studentId)) || [];
            const container = document.getElementById('history-list');
            
            if (logs.length === 0) {
                container.innerHTML = `<p class="text-[9px] text-slate-300 italic text-center py-4">No records yet for this ID.</p>`;
                return;
            }

            const grouped = {};
            logs.forEach(l => {
                if (!grouped[l.date]) grouped[l.date] = { date: l.date, in: '--:--', out: '--:--' };
                if (l.type === 'IN') grouped[l.date].in = l.time;
                if (l.type === 'OUT') grouped[l.date].out = l.time;
            });

            container.innerHTML = Object.values(grouped).map(day => `
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 shadow-sm mb-2">
                    <div class="flex justify-between items-center mb-2 border-b border-slate-200 pb-1">
                        <p class="text-[10px] font-black text-slate-800 tracking-tight">${day.date}</p>
                        <span class="text-[7px] font-black text-green-600 bg-green-100 px-1.5 py-0.5 rounded">GPS VERIFIED</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-left"><p class="text-[8px] text-slate-400 uppercase">In</p><p class="text-xs font-black text-blue-700">${day.in}</p></div>
                        <div class="text-right"><p class="text-[8px] text-slate-400 uppercase">Out</p><p class="text-xs font-black text-rose-600">${day.out}</p></div>
                    </div>
                </div>
            `).join('');
        }

        function downloadDTR() {
            const studentId = sessionStorage.getItem('current_student_id');
            const studentName = sessionStorage.getItem('current_student_name');
            const logs = JSON.parse(localStorage.getItem('wvsu_logs_' + studentId)) || [];
            if (logs.length === 0) return alert("No logs to export.");

            const grouped = {};
            logs.forEach(l => {
                if (!grouped[l.date]) grouped[l.date] = { date: l.date, in: '--:--', out: '--:--' };
                if (l.type === 'IN') grouped[l.date].in = l.time;
                if (l.type === 'OUT') grouped[l.date].out = l.time;
            });

            let content = `WVSU PC OJT DTR REPORT\nNAME: ${studentName}\nID: ${studentId}\n`;
            content += `------------------------------------\nDATE        | IN       | OUT\n------------------------------------\n`;
            Object.values(grouped).forEach(d => {
                content += `${d.date.padEnd(11)} | ${d.in.padEnd(8)} | ${d.out}\n`;
            });

            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `DTR_${studentName}.txt`;
            a.click();
        }

        function clearLogs() {
            const studentId = sessionStorage.getItem('current_student_id');
            if(confirm("Delete your history?")) {
                localStorage.removeItem('wvsu_logs_' + studentId);
                renderLogs();
            }
        }
    </script>
</body>
</html>
